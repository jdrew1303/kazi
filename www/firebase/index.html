<html>
  <head>

  	
    <!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

  	<script src='http://sugarjs.com/release/current/sugar.min.js'></script>
    <script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
    
    <style type="text/css">
    	font-size:12px;
    </style>
    

  </head>
  <body style="margin-top:50px">

  	<div class="container">

	  	<div class="panel panel-primary">
		  <!-- Default panel contents -->
		  <div class="panel-heading">KAZI Real Time Jobs Visualizer</div>
		  <div class="panel-body">
		    <p>This panel helps you visualize (via <a href="https://www.firebase.com" target="_blank">Firebase</a>) what Kazi is busy doing in near-realtime. </p>

		    <div class="list-group">
				<span href="#" class="list-group-item active"> Server Logs </span>
		    	<div id='serverLogs'> <h2>Loading Data. Please Wait...</h2></div>
		    
		    </div>
		    <div id='clientLogs'> 

		     	<div class="list-group">
					<span href="#" class="list-group-item active">
						Message Logs
					</span>

			     	<ul class="list-group" id="logs">
			     		
			     	</ul>
			    </div>

			    <div class="list-group">
					<span href="#" class="list-group-item active">
						Error Logs
					</span>

			     	<ul class="list-group" id="errors">
			     		
			     	</ul>
			    </div>

		     </div>
		  </div>

		</div>

    </div>
    
    <script>

    var obj_size=0;

    $(function(){
		var serverRef = new Firebase('https://kazilogs.firebaseio.com');
		var clientRef = new Firebase('https://clientlogs.firebaseio.com');

   		var str=$('#serverLogs').html();

		serverRef.on("value", function(snapshot) {
			var a = snapshot.exportVal();
			var j=''
			var obj={
				msg:a.msg
			}



			//table seperator row
			obj['-']=''

			if(typeof a.info !=='undefined'){
				for(var i in a.info){
					j='info: '+i;
					obj[j]=(typeof a.info[i] == 'object')? Object.values(a.info[i]): a.info[i]
				}
			}

			obj['--']=''

			if(typeof a.client !=='undefined'){
				for(var i in a.client){
					j='client: '+i.replace(/client_?/ig,'');
					obj[j]=(typeof a.client[i] == 'object')? Object.values(a.client[i]):a.client[i]
				}
			}

			//table seperator ro
			obj['---']=''

			if(typeof a.job !=='undefined'){
				for(var i in a.job){
					j='job: '+i.replace(/job_?/ig,'');
					// console.log(j)
					

					if(i=='priority'){
						obj[j]=a.job[i]+' - ( '+Date.create(a.job[i]*1000).secondsAgo()+' seconds ago )'
					}
					else if(i=='data'){
						obj[j]=decodeURIComponent(Object.toQueryString(a.job[i].data));
					}
					else{
						obj[j]=(typeof a.job[i] == 'object')? Object.values(a.job[i]):a.job[i]
					}
				}
			}

			
			if( Object.size(obj) > obj_size){
	
				var html = '<table class="table table-bordered">';
				$.each(obj, function(key, value){

					if(key.indexOf('-')==0){
						html += '<tr ><td class="" style="border:none;"></td><td class="" style="border:none;"></td></tr>';
					}
					else{
						html += '<tr>';
			            html += '<td style="width:30%" class="active"><strong>' + key.dasherize().replace(/-/g,' ').capitalize(true) + '</strong></td>';
			            html += '<td class="value" data-assign="{' + key + '}" ></td>';
			            html += '</tr>';	
					}
		        });
		        html += '</table>';

		        $('#serverLogs').html(html);
		        assign(obj)

		        //hold size in memory...
		        obj_size=Object.size(obj);
			}
			else{ assign(obj)		}
			
		});

		function assign(obj){
			$('#serverLogs table .value').each(function(){
				var el=$(this);
				el.text(el.data('assign').assign(obj).replace(/\{.+\}/,'--') )
			})
		}


		/*Client logs*/

		var max_list_size=10;
		var logs_size=0;
		var errors_size=0;

		clientRef.on("value", function(snapshot) {
			var a = snapshot.exportVal();

			if(typeof a.log !=='undefined'){
				$('#clientLogs #logs').prepend('<li class="list-group-item list-group-item-info">'+a.log+'</li>')

				if(logs_size<max_list_size){ logs_size=$('#clientLogs #logs li').length; }
				else{ $('#clientLogs #logs li:last-child').remove() }
				
			}
			else if(typeof a.error !=='undefined'){

				$('#clientLogs #errors').prepend('<li class="list-group-item list-group-item-danger">'+a.error+'</li>')

				if(errors_size<max_list_size){ errors_size=$('#clientLogs #errors li').length; }
				else{ $('#clientLogs #errors li:last-child').remove() }
			}

		})
    });
      

    </script>
  </body>
</html>